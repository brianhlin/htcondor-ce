jobs:
  - &run_tests
    # Template; subsequent uses modify 'env'
    env:
      - OS_TYPE=centos OS_VERSION=6 BUILD_ENV=uw_build DEPLOY_STAGE=false
    stage: test
    sudo: required
    services:
      - docker
    before_install:
      - sudo apt-get update
      - echo 'DOCKER_OPTS="-H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock -s devicemapper"' | sudo tee /etc/default/docker > /dev/null
      - sudo service docker restart
      - sleep 5
      - sudo docker pull centos:centos${OS_VERSION}
    script:
      - tests/setup_tests.sh
  - <<: *run_tests
    env:
      - OS_TYPE=centos OS_VERSION=7 BUILD_ENV=uw_build DEPLOY_STAGE=false
  - <<: *run_tests
    env:
      - OS_TYPE=centos OS_VERSION=6 BUILD_ENV=osg DEPLOY_STAGE=false
  - <<: *run_tests
    env:
      - OS_TYPE=centos OS_VERSION=7 BUILD_ENV=osg DEPLOY_STAGE=false

  - &deploy_rpm
    # Template; subsequent uses modify 'env'
    env:
      - OS_TYPE=centos OS_VERSION=6 BUILD_ENV=uw_build DEPLOY_STAGE=true
    stage: deploy
    sudo: required
    skip_cleanup: true
    services:
      - docker

    before_install:
      - sudo apt-get update
      - echo 'DOCKER_OPTS="-H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock -s devicemapper"' | sudo tee /etc/default/docker > /dev/null
      - sudo service docker restart
      - sleep 5
      - sudo docker pull centos:centos${OS_VERSION}
    script:
      - tests/setup_tests.sh
    deploy:
      on:
        tags: true
        all_branches: true
        draft: true
      skip_cleanup: true
      file_glob: true
      provider: releases
      overwrite: true
      # ^ this doesn't actually work but I'm leaving it in there in
      #   case it gets fixed later
      api_key:
        secure: TODO
      file: /travis_deploy/*
  - <<: *deploy_rpm
    env:
      - OS_TYPE=centos OS_VERSION=7 BUILD_ENV=uw_build DEPLOY_STAGE=true

